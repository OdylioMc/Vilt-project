# Export products and deploy to WordPress (updated to fix remote upload permissions)
# - uploads pjm-data via scp
# - then fixes permissions (directories 755, files 644)
# - optionally attempts to chown to a web user if WP_SSH_CHOWN=true and WP_SSH_CHOWN_USER set
on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  export-and-deploy:
    runs-on: windows-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Run export script (verify files then execute)
        env:
          DB_CONNECTION_STRING: ${{ secrets.DB_CONNECTION_STRING }}
        shell: pwsh
        run: |
          Write-Host "=== LIST REPOSITORY ROOT (top levels) ==="
          Get-ChildItem -Force -File -Depth 2 | ForEach-Object { Write-Host '  ' $_.FullName }

          Write-Host "=== CHECK FOR export-products.ps1 ==="
          if (Test-Path -Path .\export-products.ps1) {
            Write-Host "Found export-products.ps1 - executing..."
            & .\export-products.ps1 -OutputDir 'pjm-data' -ColumnsConfig '.\columns.json'
            $exit = $LASTEXITCODE
            Write-Host "EXPORT SCRIPT EXIT CODE: $exit"
            if ($exit -ne 0) { exit $exit }
          } else {
            Write-Error "export-products.ps1 NOT FOUND in repository workspace root. Aborting."
            exit 1
          }

      - name: "Debug: show working dir and list pjm-data"
        shell: pwsh
        run: |
          Write-Host 'Current directory:' (Get-Location).Path
          Write-Host 'Repository root listing:'
          Get-ChildItem -Force -Recurse -Depth 1 | ForEach-Object { Write-Host '  ' $_.FullName }
          if (Test-Path -Path './pjm-data') {
            Write-Host 'pjm-data exists. Listing contents:'
            Get-ChildItem -Path './pjm-data' -Recurse | ForEach-Object { Write-Host '  ' $_.FullName }
          } else {
            Write-Host 'pjm-data DOES NOT exist.'
          }

      - name: Archive export
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pjm-export
          path: pjm-data/**

      - name: Upload via SFTP/SSH (OpenSSH scp) and fix remote perms
        env:
          WP_SSH_HOST: ${{ secrets.WP_SSH_HOST }}
          WP_SSH_PORT: ${{ secrets.WP_SSH_PORT }}
          WP_SSH_USER: ${{ secrets.WP_SSH_USER }}
          WP_SSH_KEY: ${{ secrets.WP_SSH_KEY }}
          WP_SSH_KEY_B64: ${{ secrets.WP_SSH_KEY_B64 }}
          WP_TARGET_PATH: ${{ secrets.WP_TARGET_PATH }}
          WP_SSH_KNOWN_HOSTS: ${{ secrets.WP_SSH_KNOWN_HOSTS }}
          # Optional: set these secrets to enable chown on remote (requires sudo without password)
          # WP_SSH_CHOWN: 'true'
          # WP_SSH_CHOWN_USER: 'www-data:www-data'
        shell: pwsh
        run: |
          pwsh -NoProfile -NoLogo -Command {
            if (-not $env:WP_SSH_HOST -or $env:WP_SSH_HOST -eq '') {
              Write-Host "WP_SSH_HOST is empty â€” skipping upload."
              exit 0
            }
            if (-not $env:WP_SSH_PORT -or $env:WP_SSH_PORT -eq '') { $env:WP_SSH_PORT = '22' }

            $keyFile = Join-Path $env:RUNNER_TEMP 'wp_ssh_key'

            if ($env:WP_SSH_KEY_B64 -and $env:WP_SSH_KEY_B64 -ne '') {
              Write-Host "Decoding base64 SSH key to $keyFile"
              try {
                $bytes = [System.Convert]::FromBase64String($env:WP_SSH_KEY_B64)
                [System.IO.File]::WriteAllBytes($keyFile, $bytes)
              } catch {
                Write-Error "Failed to decode WP_SSH_KEY_B64: $_"
                exit 1
              }
            } elseif ($env:WP_SSH_KEY -and $env:WP_SSH_KEY -ne '') {
              Write-Host "Writing plain-text SSH key to $keyFile (ensure secret uses real newlines)"
              $textBytes = [System.Text.Encoding]::UTF8.GetBytes($env:WP_SSH_KEY)
              [System.IO.File]::WriteAllBytes($keyFile, $textBytes)
            } else {
              Write-Error "No SSH key secret provided. Set WP_SSH_KEY_B64 (preferred) or WP_SSH_KEY."
              exit 1
            }

            # Restrict permissions on the key file (Windows)
            icacls $keyFile /inheritance:r | Out-Null
            icacls $keyFile /grant:r "$($env:USERNAME):R" | Out-Null

            # Prepare known_hosts if provided
            $knownHostsFile = Join-Path $env:RUNNER_TEMP 'known_hosts'
            $sshOptions = @()
            if ($env:WP_SSH_KNOWN_HOSTS -and $env:WP_SSH_KNOWN_HOSTS -ne '') {
              Set-Content -Path $knownHostsFile -Value $env:WP_SSH_KNOWN_HOSTS -NoNewline
              $sshOptions += "-o"
              $sshOptions += "UserKnownHostsFile=`"$knownHostsFile`""
              $sshOptions += "-o"
              $sshOptions += "StrictHostKeyChecking=yes"
            } else {
              $sshOptions += "-o"
              $sshOptions += "StrictHostKeyChecking=no"
            }

            Write-Host "Creating remote path..."
            $mkdirCmd = @("ssh","-i",$keyFile,"-p",$env:WP_SSH_PORT) + $sshOptions + @("$($env:WP_SSH_USER)@$($env:WP_SSH_HOST)","mkdir -p `"$($env:WP_TARGET_PATH)`"")
            Write-Host "SSH mkdir command: $($mkdirCmd -join ' ')"
            $proc = Start-Process -FilePath $mkdirCmd[0] -ArgumentList $mkdirCmd[1..($mkdirCmd.Length-1)] -NoNewWindow -Wait -PassThru
            if ($proc.ExitCode -ne 0) {
              Write-Host "Remote mkdir command failed with exit code $($proc.ExitCode). Continuing to attempt upload..."
            }

            Write-Host "Uploading files with scp..."
            $scpCmd = @("scp","-i",$keyFile,"-P",$env:WP_SSH_PORT) + $sshOptions + @("-r","pjm-data/*","$($env:WP_SSH_USER)@$($env:WP_SSH_HOST):`"$($env:WP_TARGET_PATH)/`"")
            Write-Host "SCP command: $($scpCmd -join ' ')"
            $proc2 = Start-Process -FilePath $scpCmd[0] -ArgumentList $scpCmd[1..($scpCmd.Length-1)] -NoNewWindow -Wait -PassThru
            if ($proc2.ExitCode -ne 0) { Write-Error "SCP failed with exit code $($proc2.ExitCode)"; exit $proc2.ExitCode } else { Write-Host "Upload successful." }

            # ---------------------------
            # Remote permissions fix
            # ---------------------------
            try {
              # Remote path to the uploaded data (ensure trailing path correct)
              $remoteDataPath = "$($env:WP_TARGET_PATH)/pjm-data"

              # Build the remote command: set directories to 755 and files to 644
              $fixPermCmd = "if [ -d `"$remoteDataPath`" ]; then find `"$remoteDataPath`" -type d -exec chmod 755 {} \; && find `"$remoteDataPath`" -type f -exec chmod 644 {} \;; else echo 'Remote path not found: $remoteDataPath'; fi"

              $sshFixCmd = @("ssh","-i",$keyFile,"-p",$env:WP_SSH_PORT) + $sshOptions + @("$($env:WP_SSH_USER)@$($env:WP_SSH_HOST)","$fixPermCmd")
              Write-Host "Running remote permission-fix: $($sshFixCmd -join ' ')"
              $proc3 = Start-Process -FilePath $sshFixCmd[0] -ArgumentList $sshFixCmd[1..($sshFixCmd.Length-1)] -NoNewWindow -Wait -PassThru
              if ($proc3.ExitCode -ne 0) {
                Write-Warning "Remote chmod command failed with exit code $($proc3.ExitCode)"
              } else {
                Write-Host "Remote permissions fixed (chmod)."
              }

              # Optional: change owner if requested. This requires the SSH user to have passwordless sudo.
              if ($env:WP_SSH_CHOWN -and $env:WP_SSH_CHOWN.ToLower() -eq 'true') {
                $targetOwner = if ($env:WP_SSH_CHOWN_USER -and $env:WP_SSH_CHOWN_USER -ne '') { $env:WP_SSH_CHOWN_USER } else { 'www-data:www-data' }
                $fixOwnerCmd = "if [ -d `"$remoteDataPath`" ]; then sudo chown -R $targetOwner `"$remoteDataPath`" && sudo find `"$remoteDataPath`" -type d -exec chmod 755 {} \; && sudo find `"$remoteDataPath`" -type f -exec chmod 644 {} \;; else echo 'Remote path not found for chown: $remoteDataPath'; fi"
                $sshChownCmd = @("ssh","-i",$keyFile,"-p",$env:WP_SSH_PORT) + $sshOptions + @("$($env:WP_SSH_USER)@$($env:WP_SSH_HOST)","$fixOwnerCmd")
                Write-Host "Attempting remote chown+chmod (requires sudo): $($sshChownCmd -join ' ')"
                $proc4 = Start-Process -FilePath $sshChownCmd[0] -ArgumentList $sshChownCmd[1..($sshChownCmd.Length-1)] -NoNewWindow -Wait -PassThru
                if ($proc4.ExitCode -ne 0) {
                  Write-Warning "Remote chown/chmod failed (exit code $($proc4.ExitCode)). If you need chown, ensure the SSH user has passwordless sudo or run manually on the server."
                } else {
                  Write-Host "Remote ownership and permissions adjusted with sudo."
                }
              }

            } catch {
              Write-Warning "Failed to fix remote permissions: $($_.Exception.Message)"
            }

          }
